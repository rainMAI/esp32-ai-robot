# 龙眼主题问题分析报告

## 一、文件使用关系分析

### 1.1 文件关系图

```
┌─────────────────────────────────────────────────────────────┐
│                   龙眼主题文件体系                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ❌ 已废弃                                                    │
│  ┌────────────────────────────────┐                         │
│  │  dragon_eye_data.h             │                         │
│  │  (160×160 原始数据)             │                         │
│  │  - sclera_dragon[160×160]      │                         │
│  └────────────────────────────────┘                         │
│           ⬇ 未被使用                                         │
│                                                              │
│  ✅ 实际使用                                                  │
│  ┌────────────────────────────────┐                         │
│  │  dragon_theme_data.h           │  ──────────┐           │
│  │  (头文件 - 声明)                │            │           │
│  │  namespace DragonTheme {        │            │           │
│  │    extern dragon_sclera        │            │           │
│  │    extern dragon_iris          │            │           │
│  │  }                              │            │           │
│  └────────────────────────────────┘            │           │
│           ⬆                                     │           │
│           │ 引用                                │           │
│  ┌────────────────────────────────┐            │           │
│  │  dragon_theme_data.cc          │  ◀─────────┘           │
│  │  (实现文件 - 数据定义)          │                        │
│  │  namespace DragonTheme {        │                        │
│  │    sclera_data[375×375]        │  ⬅ 从160×160放大      │
│  │    dragon_iris_data[256×64]    │  ⬅ 从80×512调整        │
│  │  }                              │                        │
│  └────────────────────────────────┘                        │
│           ⬆                                                 │
│           │ 被引用                                          │
│  ┌────────────────────────────────┐                        │
│  │  eye_themes.cc                 │                        │
│  │  (主题配置)                     │                        │
│  │  theme_configs[] = {           │                        │
│  │    {                           │                        │
│  │      .name = "dragon",         │                        │
│  │      .sclera = dragon_sclera   │  ⬅ 使用龙眼巩膜        │
│  │      .iris = dragon_iris       │  ⬅ 使用龙眼虹膜        │
│  │    }                           │                        │
│  │  }                              │                        │
│  └────────────────────────────────┘                        │
│                                                              │
│  ✅ 全局共享（所有主题共用）                                  │
│  ┌────────────────────────────────┐                        │
│  │  eyes_data.h                   │                        │
│  │  (全局数据)                     │                        │
│  │  - polar_default[150×150]      │  ⬅ 所有主题共用        │
│  │  - upper_default[240×240]      │  ⬅ 所有主题共用        │
│  │  - lower_default[240×240]      │  ⬅ 所有主题共用        │
│  │  - sclera_xingkong[375×375]   │                        │
│  │  - iris_xingkong[256×64]      │                        │
│  └────────────────────────────────┘                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 关键发现

#### ✅ **dragon_eye_data.h 文件确实没有使用**
- 该文件包含原始的 160×160 龙眼数据
- 已经被 `dragon_theme_data.h/cc` 替代
- 可以安全删除

#### ✅ **polar 和 upper/lower 在哪里？**
答案：**所有主题共享使用 `eyes_data.h` 中的数据**

```cpp
// eye_display.cc:47-53
const uint16_t *sclera = sclera_xingkong;  // ⬅ 可切换为 dragon_sclera
const uint16_t *polar = polar_default;      // ⬅ 固定，不可切换
const uint8_t *upper = upper_default;       // ⬅ 固定，不可切换
const uint8_t *lower = lower_default;       // ⬅ 固定，不可切换
const uint16_t *iris = iris_xingkong;       // ⬅ 可切换为 dragon_iris
```

#### ❗ **重要：当前系统设计的局限性**

当前实现中：
- ✅ `sclera` 和 `iris` **可以**通过主题切换
- ❌ `polar`、`upper`、`lower` **不可以**切换（所有主题共用）

## 二、龙眼瞳孔无法显示的问题分析

### 2.1 问题根源

龙眼的瞳孔是**横向的椭圆**（而不是圆形的），这导致使用标准的 `polar_default` 极坐标映射无法正确渲染。

```
正常眼睛（圆形瞳孔）          龙眼（横向椭圆瞳孔）
┌──────────────┐            ┌──────────────┐
│      ○○      │            │     ───      │
│     ○  ○     │            │    ○    ○    │
│      ◉◉      │            │     ───◉─    │  ⬅ 横向椭圆
│     ○  ○     │            │    ○    ○    │
│      ○○      │            │     ───      │
└──────────────┘            └──────────────┘
   适用于标准极坐标              需要特殊的极坐标映射
   polar_default               需要自定义 dragon_polar
```

### 2.2 技术原因

#### 标准 `polar_default` 的工作原理

```cpp
// polar_default 存储圆形虹膜的极坐标映射
// 假设 polar[y][x] = 0xABCD
//
//  高7位 (0xAB = 171) → 虹膜纹理的 X 坐标（角度）
//  低7位 (0xCD = 205) → 虹膜纹理的 Y 坐标（距离）
//
// 渲染时：
//   iris_x = (256 * angle) / 512
//   iris_y = (iScale * distance) / 240
//
// 这适用于圆形或径向对称的虹膜
```

#### 龙眼的特殊性

```
原始龙眼虹膜尺寸：80×512
├─ 80 行 → 距离（从中心向外）
└─ 512 列 → 角度（环绕中心）

转换为 256×64 后：
├─ 64 行 → 距离（从中心向外）
└─ 256 列 → 角度（环绕中心）

但是！龙眼的瞳孔是横向椭圆，这意味着：
- 同一距离上，横向的瞳孔宽度 ≠ 纵向的瞳孔宽度
- 标准的极坐标映射无法正确处理这种非圆形对称
```

### 2.3 视觉效果对比

```
使用 polar_default 渲染龙眼：
┌──────────────────────────────┐
│                              │
│    预期的龙眼瞳孔              │
│   ═════════════             │
│   ○            ○            │
│   ════●═══════●════         │  ⬅ 横向椭圆瞳孔
│   ○            ○            │
│   ═════════════             │
│                              │
└──────────────────────────────┘

实际显示效果（可能是）：
┌──────────────────────────────┐
│                              │
│    实际渲染结果                │
│   ◯◯◯◯◯◯◯◯◯◯◯◯             │
│   ○      ●      ○           │  ⬅ 变成圆形或扭曲
│   ◯◯◯◯◯◯◯◯◯◯◯◯             │
│                              │
└──────────────────────────────┘

问题：polar_default 将横向椭圆拉伸成了圆形
```

## 三、解决方案

### 3.1 方案一：创建龙眼专用的 polar 映射（推荐）

#### 步骤：

1. **创建 `dragon_polar[150×150]` 数据**
   - 根据龙眼瞳孔的椭圆形状计算极坐标
   - 横向距离缩放比例 ≠ 纵向距离缩放比例

2. **修改主题配置支持自定义 polar**

```cpp
// eye_themes.h 修改
typedef struct {
    const char* name;
    const uint16_t* sclera;
    const uint16_t* iris;
    const uint16_t* polar;  // ⬅ 新增：支持自定义 polar
    int width;
    int height;
    int iris_min;
    int iris_max;
} EyeThemeConfig;

// eye_themes.cc 修改
{
    .name = "dragon",
    .sclera = DragonTheme::dragon_sclera,
    .iris = DragonTheme::dragon_iris,
    .polar = DragonTheme::dragon_polar,  // ⬅ 使用龙眼专用的 polar
    .width = 375,
    .height = 375,
    .iris_min = 180,
    .iris_max = 280
}
```

3. **修改渲染逻辑**

```cpp
// eye_display.cc 修改
const uint16_t *polar = theme_config->polar ?
                         theme_config->polar :
                         polar_default;  // 默认使用 polar_default
```

#### 生成 dragon_polar 的方法：

```python
# 伪代码：生成龙眼的椭圆极坐标映射
def generate_dragon_polar():
    polar = array(150×150)

    for y in range(150):
        for x in range(150):
            # 计算相对于中心的坐标
            dx = x - 75
            dy = y - 75

            # 椭圆瞳孔参数
            ellipse_ratio = 1.5  # 横向是纵向的 1.5 倍

            # 计算角度（标准计算）
            angle = atan2(dy, dx) * 128 / PI + 128

            # 计算距离（椭圆距离）
            distance_x = dx / ellipse_ratio  # 横向压缩
            distance = sqrt(distance_x**2 + dy**2)
            distance = min(distance * 2, 127)  # 缩放到 0-127

            # 组合 angle 和 distance
            polar[y][x] = (int(angle) << 7) | int(distance)

    return polar
```

### 3.2 方案二：修改虹膜纹理（较简单但效果有限）

调整 `dragon_iris` 的尺寸，使瞳孔接近圆形：

```cpp
// 将椭圆瞳孔"拉伸"成圆形
// 原始：横向椭圆
// 调整：纵向拉伸使其接近圆形
```

**缺点**：会改变龙眼的原始外观

### 3.3 方案三：在渲染时进行椭圆变换（性能较差）

```cpp
// 在 drawEye() 中检测龙眼主题并应用椭圆变换
if (current_theme == DRAGON) {
    // 对 irisX 应用椭圆缩放
    irisX_scaled = irisX * 1.5;  // 横向拉伸
}
```

**缺点**：增加渲染计算量，影响帧率

### 3.4 方案四：接受当前效果（最简单）

如果龙眼的圆形瞳孔效果可接受，可以不做修改。

## 四、数据总结

### 4.1 龙眼主题当前使用的数据

| 数据类型 | 来源 | 文件 | 尺寸 | 用途 |
|---------|------|------|------|------|
| **sclera** | ✅ 龙眼专用 | dragon_theme_data.cc | 375×375 | 龙眼巩膜 |
| **iris** | ✅ 龙眼专用 | dragon_theme_data.cc | 256×64 | 龙眼虹膜 |
| **polar** | ❌ 全局共享 | eyes_data.h | 150×150 | 极坐标映射（圆形）|
| **upper** | ❌ 全局共享 | eyes_data.h | 240×240 | 上眼睑遮罩 |
| **lower** | ❌ 全局共享 | eyes_data.h | 240×240 | 下眼睑遮罩 |

### 4.2 dragon_theme_data.cc 的实际内容

```cpp
// 第 8802 行
const uint16_t* const dragon_sclera = sclera_data;
// ⬅ sclera_data[375×375] 的定义在前面的代码中

// 第 9834 行
const uint16_t* const dragon_iris = dragon_iris_data;
// ⬅ dragon_iris_data[256×64] 的定义在前面的代码中

// 文件总行数：9836 行
// 包含：
//   - sclera_data: 从 160×160 放大到 375×375
//   - dragon_iris_data: 从 80×512 调整到 256×64
```

## 五、推荐行动计划

### 立即可做：

1. ✅ **删除废弃文件**
   ```bash
   git rm main/display/dragon_eye_data.h
   ```

2. ✅ **验证龙眼数据**
   - 检查 `dragon_iris` 的瞳孔形状
   - 确认是否真的需要自定义 polar

### 如果需要修复瞳孔形状：

3. ⚠️ **生成 dragon_polar 数据**
   - 使用上述 Python 脚本生成
   - 添加到 `dragon_theme_data.cc`

4. ⚠️ **修改主题系统**
   - 更新 `EyeThemeConfig` 结构
   - 修改 `eye_display.cc` 支持自定义 polar
   - 更新龙眼主题配置

### 测试验证：

5. ✅ **编译并测试**
   ```bash
   idf.py build
   idf.py flash monitor
   ```

6. ✅ **验证龙眼显示效果**
   - 检查瞳孔形状是否正确
   - 验证眨眼动画
   - 检查虹膜缩放

## 六、总结

### 核心问题：

1. ❌ **dragon_eye_data.h** 文件未被使用，可以删除
2. ❌ **polar/upper/lower** 在 `eyes_data.h` 中，所有主题共享
3. ❌ **龙眼瞳孔无法正确显示**：因为使用标准的圆形 `polar_default` 映射

### 解决方案：

- **短期**：删除废弃文件，接受当前效果
- **长期**：实现自定义 polar 映射，完善龙眼显示效果

### 预期工作量：

- 删除废弃文件：5 分钟
- 生成 dragon_polar 数据：1-2 小时
- 修改主题系统：2-3 小时
- 测试验证：1 小时

---

**文档版本**: v1.0
**分析日期**: 2025-12-29
**相关文件**:
- [main/display/dragon_eye_data.h](main/display/dragon_eye_data.h) - 可删除
- [main/display/dragon_theme_data.h](main/display/dragon_theme_data.h) - 使用中
- [main/display/dragon_theme_data.cc](main/display/dragon_theme_data.cc) - 使用中
- [main/display/eye_themes.cc](main/display/eye_themes.cc) - 主题配置
- [main/display/eyes_data.h](main/display/eyes_data.h) - 全局共享数据
