# 龙眼瞳孔形状问题技术分析

## 一、原始龙眼数据分析

### 1.1 原始文件中的尺寸定义

```cpp
// main/display/graphics/dragonEye.h

#define IRIS_MIN       80   // 龙眼专用的虹膜最小尺寸
#define IRIS_MAX       400  // 龙眼专用的虹膜最大尺寸

#define SCLERA_WIDTH   160  // 巩膜宽度
#define SCLERA_HEIGHT  160  // 巩膜高度

#define IRIS_MAP_WIDTH  512 // 虹膜映射宽度（角度）
#define IRIS_MAP_HEIGHT 80  // 虹膜映射高度（距离）
```

### 1.2 关键发现：虹膜纹理的特殊性

```
龙眼虹膜原始尺寸：80 × 512
┌───────────────────────────────────────┐
│  80 行 (Y轴) = 距离维度                │
│  512 列 (X轴) = 角度维度                │
└───────────────────────────────────────┘

对比其他眼睛的虹膜：
┌───────────────────────────────────────┐
│  星空虹膜：64 × 256                    │
│  标准虹膜：距离 × 角度                  │
└───────────────────────────────────────┘

差异：
- 龙眼：80行 × 512列 = 更宽的角度范围
- 标准：64行 × 256列 = 标准角度范围
```

### 1.3 龙眼虹膜纹理的可视化

```
原始龙眼虹膜（80×512）展开图：
┌────────────────────────────────────────────┐
│ 距离 │ 0   1   2   3 ... 511 (角度)        │
├──────┼────────────────────────────────────┤
│  79  │ ═════════════════════════════      │  ← 最外层
│  78  │ ═════════════════════════════      │
│  ... │                                   │
│  40  │ ═════════════════════════════      │
│      │                                   │
│  30  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━      │
│  20  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━      │
│  10  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━      │
│   0  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━      │  ← 瞳孔中心
└────────────────────────────────────────────┘

特点：
- 512列 = 360° × 高精度采样
- 80行 = 从瞳孔中心到边缘的80个距离层级
- **横向椭圆瞳孔**：横向角度覆盖范围更广
```

## 二、转换到标准尺寸的影响

### 2.1 转换过程

```
原始龙眼虹膜：80 × 512
        ⬇ 调整（脚本转换）
转换后虹膜：64 × 256

调整方法：
- 80行 → 64行：距离维度压缩（80 × 0.8 = 64）
- 512列 → 256列：角度维度压缩（512 × 0.5 = 256）
```

### 2.2 转换的影响分析

#### ❌ 问题1：角度精度损失

```
原始：512列 → 每列 ≈ 0.7° (360°/512)
转换：256列 → 每列 ≈ 1.4° (360°/256)

影响：
- 角度分辨率降低 50%
- 椭圆瞳孔的横向细节丢失
```

#### ❌ 问题2：距离精度损失

```
原始：80行 → 每行 ≈ 1.25% 的半径
转换：64行 → 每行 ≈ 1.56% 的半径

影响：
- 距离分辨率降低 20%
- 瞳孔边缘的平滑度下降
```

#### ❌ 问题3：椭圆形状失真

```
原始龙眼瞳孔（横向椭圆）：
  ┌──────────────┐
  │   ──────     │  长轴 : 短轴 = 1.5 : 1
  │  ════════    │
  │  ──────      │
  └──────────────┘

使用 polar_default 渲染（圆形极坐标）：
  ┌──────────────┐
  │  ════════    │  被拉伸成圆形
  │ ══════════   │  长轴 : 短轴 = 1 : 1
  │  ════════    │
  └──────────────┘

结果：横向椭圆变成了圆形！
```

## 三、技术原因详解

### 3.1 标准 polar_default 的工作原理

```cpp
// polar_default 假设虹膜是圆形对称的
for (int y = 0; y < 150; y++) {
    for (int x = 0; x < 150; x++) {
        // 计算到中心的距离（圆形）
        int dx = x - 75;
        int dy = y - 75;
        int distance = sqrt(dx*dx + dy*dy);

        // 计算角度（径向）
        int angle = atan2(dy, dx);

        // 存储：angle (高7位) | distance (低7位)
        polar[y][x] = (angle << 7) | distance;
    }
}
```

### 3.2 为什么标准 polar 无法渲染龙眼

```
问题：polar_default 是为圆形虹膜设计的

圆形虹膜的极坐标映射：
        0°
         ↑
         │
    270° │ 90°
         │
        180°

特点：
- 所有角度上的距离变化相同
- 径向对称
- 使用 standard polar 可以正确映射

椭圆虹膜的极坐标映射：
        0°
         ↑
         ●
    270° │ 90°
    ─────●───────  ← 横向更长！
         ●
        180°

特点：
- 不同角度上的距离变化不同
- 非径向对称
- 需要 custom polar 映射
```

### 3.3 渲染失真的可视化

```
场景：渲染龙眼的瞳孔边缘

预期效果（横向椭圆）：
┌────────────────────────────────┐
│                                │
│     ⚪────────⚪              │
│    ╱              ╲            │  ← 横向椭圆瞳孔
│   │                │           │
│    ╲              ╱            │
│     ⚪────────⚪              │
│                                │
└────────────────────────────────┘

实际效果（使用 polar_default）：
┌────────────────────────────────┐
│                                │
│       ⚪────⚪                │
│      ╱          ╲             │  ← 被拉伸成圆形
│     │            │            │
│      ╲          ╲             │
│       ⚪────⚪                │
│                                │
└────────────────────────────────┘

原因：
- polar_default 将 (x,y) 映射到 (angle, distance)
- 假设所有角度上的 distance 是相同的
- 但椭圆瞳孔在不同角度上的 distance 是不同的
```

## 四、解决方案对比

### 方案1：创建龙眼专用 polar（最优）

```cpp
// dragon_polar[150×150] - 专门为龙眼设计
for (int y = 0; y < 150; y++) {
    for (int x = 0; x < 150; x++) {
        float dx = (x - 75) / 75.0f;  // 归一化到 [-1, 1]
        float dy = (y - 75) / 75.0f;

        // 龙眼瞳孔的椭圆比率
        const float ellipse_ratio = 1.5f;  // 横向是纵向的1.5倍

        // 应用椭圆变换
        dx /= ellipse_ratio;  // 横向压缩

        // 计算椭圆距离
        float distance = sqrt(dx*dx + dy*dy);
        distance = fmin(distance * 127, 127);

        // 计算角度
        float angle = atan2(dy, dx);
        angle = (angle + M_PI) * 128 / M_PI;
        angle = fmin(angle, 127);

        // 存储到 polar 数组
        dragon_polar[y*150 + x] = ((int)angle << 7) | (int)distance;
    }
}
```

**优点**：
- ✅ 完美保留龙眼的椭圆瞳孔
- ✅ 渲染性能不受影响
- ✅ 可以精确控制瞳孔形状

**缺点**：
- ❌ 需要修改主题系统支持自定义 polar
- ❌ 增加数据存储（150×150×2 = 45KB）

### 方案2：修改虹膜纹理（次优）

```cpp
// 在转换时，将椭圆瞳孔"拉伸"成圆形
// 修改 extract_dragon_theme.py
```

**优点**：
- ✅ 不需要修改渲染系统
- ✅ 实现简单

**缺点**：
- ❌ 改变了龙眼的原始外观
- ❌ 瞳孔变得不自然

### 方案3：在渲染时应用椭圆变换（不推荐）

```cpp
// 在 drawEye() 中检测龙眼主题
if (current_theme == DRAGON) {
    // 应用椭圆变换
    irisX = (irisX - 75) * 1.5 + 75;  // 横向拉伸
}
```

**优点**：
- ✅ 灵活性高

**缺点**：
- ❌ 每个像素都要计算，性能差
- ❌ 增加渲染延迟
- ❌ 可能导致帧率下降

## 五、当前系统的问题总结

### 5.1 架构限制

```
当前系统的主题配置：

typedef struct {
    const char* name;
    const uint16_t* sclera;    // ✅ 可自定义
    const uint16_t* iris;      // ✅ 可自定义
    // ❌ 缺少 polar 字段
    // ❌ 缺少 upper/lower 字段
    int width;
    int height;
    int iris_min;
    int iris_max;
} EyeThemeConfig;

问题：
- 所有主题共享 polar_default
- 所有主题共享 upper_default/lower_default
- 无法为特殊眼睛（如龙眼）定制极坐标映射
```

### 5.2 数据流分析

```
┌────────────────────────────────────────────────────┐
│                  龙眼主题渲染流程                   │
├────────────────────────────────────────────────────┤
│                                                     │
│  1. 主题选择                                        │
│     └─ theme = "dragon"                            │
│         ├─ sclera → DragonTheme::dragon_sclera  ✅ │
│         └─ iris → DragonTheme::dragon_iris      ✅ │
│                                                     │
│  2. 渲染初始化 (eye_display.cc)                     │
│     ├─ polar = polar_default                    ❌ │
│     ├─ upper = upper_default                     ❌ │
│     └─ lower = lower_default                     ❌ │
│                                                     │
│  3. 像素渲染                                        │
│     └─ 使用 polar_default 映射虹膜坐标             ❌ │
│         └─ 横向椭圆被拉伸成圆形                    ❌ │
│                                                     │
│  4. 显示效果                                        │
│     └─ 龙眼瞳孔变成圆形 ❌ 而不是横向椭圆 ❌        │
│                                                     │
└────────────────────────────────────────────────────┘
```

## 六、推荐解决方案

### 方案：创建 dragon_polar 并修改主题系统

#### 步骤1：生成 dragon_polar 数据

创建脚本 `generate_dragon_polar.py`：

```python
#!/usr/bin/env python3
import math
import struct

def generate_dragon_polar():
    """生成龙眼专用的极坐标映射"""

    width, height = 150, 150
    center_x, center_y = width // 2, height // 2

    polar = []
    ellipse_ratio = 1.5  # 横向是纵向的1.5倍

    for y in range(height):
        for x in range(width):
            # 计算归一化坐标
            dx = (x - center_x) / center_x
            dy = (y - center_y) / center_y

            # 应用椭圆变换
            dx /= ellipse_ratio  # 横向压缩

            # 计算距离
            distance = math.sqrt(dx*dx + dy*dy)
            distance = min(int(distance * 127), 127)

            # 计算角度
            angle = math.atan2(dy, dx)
            angle = int((angle + math.pi) * 128 / math.pi)
            angle = min(angle, 127)

            # 组合
            value = (angle << 7) | distance
            polar.append(value)

    return polar

def write_polar_file(filename, polar_data):
    """写入极坐标数据到C文件"""
    with open(filename, 'w') as f:
        f.write("// Dragon eye polar coordinate mapping\n")
        f.write("// Auto-generated by generate_dragon_polar.py\n\n")
        f.write("#include <stdint.h>\n\n")
        f.write("namespace DragonTheme {\n\n")
        f.write("const uint16_t dragon_polar[150 * 150] = {\n")

        for i in range(0, len(polar_data), 10):
            line_data = polar_data[i:i+10]
            line = ", ".join(f"0x{val:04X}" for val in line_data)
            f.write(f"    {line},\n")

        f.write("};\n\n")
        f.write("} // namespace DragonTheme\n")

if __name__ == "__main__":
    print("Generating dragon polar mapping...")
    polar = generate_dragon_polar()
    write_polar_file("dragon_polar_data.cc", polar)
    print(f"Generated {len(polar)} values")
    print("Output: dragon_polar_data.cc")
```

#### 步骤2：修改主题配置

```cpp
// eye_themes.h
typedef struct {
    const char* name;
    const uint16_t* sclera;
    const uint16_t* iris;
    const uint16_t* polar;  // ⬅ 新增
    int width;
    int height;
    int iris_min;
    int iris_max;
} EyeThemeConfig;

// eye_themes.cc
{
    .name = "dragon",
    .sclera = DragonTheme::dragon_sclera,
    .iris = DragonTheme::dragon_iris,
    .polar = DragonTheme::dragon_polar,  // ⬅ 使用龙眼专用 polar
    .width = 375,
    .height = 375,
    .iris_min = 180,
    .iris_max = 280
}
```

#### 步骤3：修改渲染逻辑

```cpp
// eye_display.cc
const uint16_t *polar = current_theme->polar ?
                         current_theme->polar :
                         polar_default;
```

### 预期效果对比

```
修改前（使用 polar_default）：
┌──────────────────┐
│  ═════════      │  ← 圆形瞳孔
│ ═════════════   │
│  ═════════      │
└──────────────────┘

修改后（使用 dragon_polar）：
┌──────────────────┐
│  ════════════   │  ← 横向椭圆瞳孔
│ ══════════════  │
│  ════════════   │
└──────────────────┘
```

## 七、总结

### 核心问题：

1. ❌ **dragon_eye_data.h** 未使用，可删除
2. ❌ **polar/upper/lower** 所有主题共享
3. ❌ **龙眼瞳孔失真**：横向椭圆被渲染成圆形

### 根本原因：

- `polar_default` 是为圆形虹膜设计的
- 龙眼是横向椭圆瞳孔
- 使用标准极坐标映射导致形状失真

### 解决方案：

- **长期**：生成 `dragon_polar`，支持主题自定义 polar
- **短期**：删除废弃文件，接受当前效果

### 工作量估算：

- 生成 dragon_polar：1 小时
- 修改主题系统：2 小时
- 测试验证：1 小时
- **总计**：约 4 小时

---

**文档版本**: v1.0
**分析日期**: 2025-12-29
**相关文件**:
- [龙眼主题问题分析报告.md](龙眼主题问题分析报告.md) - 完整问题分析
- [main/display/graphics/dragonEye.h](main/display/graphics/dragonEye.h) - 原始龙眼数据
- [main/display/dragon_theme_data.cc](main/display/dragon_theme_data.cc) - 当前使用的龙眼数据
