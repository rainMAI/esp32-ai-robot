# 眼睛渲染流程详解

## 一、数据流转图

```
┌────────────────────────────────────────────────────────────────┐
│                        眼睛数据源                              │
├────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │  sclera[]    │  │   iris[]     │  │  polar[]     │        │
│  │  375×375     │  │  256×64      │  │  150×150     │        │
│  │  RGB565      │  │  RGB565      │  │  RGB565      │        │
│  │  (眼白纹理)  │  │  (虹膜纹理)  │  │  (极坐标映射) │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐                           │
│  │  upper[]     │  │  lower[]     │                           │
│  │  240×240     │  │  240×240     │                           │
│  │  8-bit       │  │  8-bit       │                           │
│  │  (上眼睑)    │  │  (下眼睑)    │                           │
│  └──────────────┘  └──────────────┘                           │
└────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌────────────────────────────────────────────────────────────────┐
│                    drawEye() 渲染函数                           │
└────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌────────────────────────────────────────────────────────────────┐
│                  像素级渲染决策流程                            │
└────────────────────────────────────────────────────────────────┘

    对于每个像素 (screenX, screenY):
    ┌────────────────────────────────────────┐
    │ 1. 检查眼睑遮挡                         │
    │    upper[screenIdx] <= uT ?            │
    │    lower[screenIdx] <= lT ?            │
    └────────────┬───────────────────────────┘
                 │
        ┌────────┴────────┐
        │                 │
       Yes               No
        │                 │
        ▼                 ▼
  ┌──────────┐    ┌──────────────────┐
  │ 显示黑色  │    │ 2. 检查是否在虹膜区 │
  │ p = 0    │    │ irisX/irisY有效?   │
  └──────────┘    └─────────┬──────────┘
                            │
                   ┌────────┴────────┐
                   │                 │
                  No               Yes
                   │                 │
                   ▼                 ▼
            ┌──────────┐    ┌─────────────────┐
            │ 显示巩膜  │    │ 3. 极坐标映射    │
            │sclera[...]│    │ p = polar[...]  │
            └──────────┘    └────────┬────────┘
                                     │
                                     ▼
                            ┌──────────────────┐
                            │ 4. 提取距离和角度 │
                            │ d = p & 0x7F     │
                            │ a = p >> 7       │
                            └────────┬─────────┘
                                     │
                                     ▼
                            ┌──────────────────┐
                            │ 5. 距离缩放计算   │
                            │ d = (iScale*d)/240│
                            └────────┬─────────┘
                                     │
                            ┌────────┴────────┐
                            │                 │
                          d<64              d>=64
                            │                 │
                            ▼                 ▼
                    ┌─────────────┐    ┌──────────┐
                    │ 显示虹膜    │    │ 显示巩膜 │
                    │iris[d][a]  │    │sclera[...]│
                    └─────────────┘    └──────────┘
```

## 二、极坐标映射详解

### 2.1 polar[] 数组的位结构

```
polar 值 (16-bit):
┌────────────────────────────────────────────┐
│ 位15-9      │    位8-0                    │
│ 高7位       │    低7位                     │
│ 角度索引    │    距离值                    │
│ (0-127)    │    (0-127)                   │
└─────────────┴──────────────────────────────┘

例如: polar[y][x] = 0xABCD
     ├─ 高7位 (0xAB = 171): 角度索引
     └─ 低7位 (0xCD = 205): 距离值 (实际只取低7位 = 45)
```

### 2.2 极坐标到屏幕坐标的映射

```
虹膜纹理（极坐标）         屏幕坐标（直角坐标）
┌──────────────┐          ┌──────────────┐
│              │          │              │
│   iris[][]   │  ──────▶ │   polar[][]  │
│  256列×64行  │    映射   │  150×150     │
│              │          │              │
└──────────────┘          └──────────────┘

虹膜纹理坐标计算：
  X坐标 = a = (IRIS_MAP_WIDTH * (p >> 7)) / 512
  Y坐标 = d = (iScale * (p & 0x7F)) / 240

  其中:
    - p >> 7: 从 polar 提取角度索引 (0-127)
    - p & 0x7F: 从 polar 提取距离值 (0-127)
    - iScale: 虹膜缩放因子 (180-280)
    - IRIS_MAP_WIDTH = 256
```

### 2.3 虹膜缩放示例

```cpp
// 示例1: 小虹膜 (iScale = 180)
polar_value = 0x1234
d = (180 * (0x34 & 0x7F)) / 240  // d = (180 * 52) / 240 = 39
// 距离较小 → 虹膜看起来较小

// 示例2: 大虹膜 (iScale = 280)
d = (280 * (0x34 & 0x7F)) / 240  // d = (280 * 52) / 240 = 60
// 距离较大 → 虹膜看起来较大
```

## 三、眼睑遮挡机制

### 3.1 眨眼状态机

```
┌─────────┐
│ NOBLINK │ ◀─────┐
│ (不眨眼) │        │
└────┬────┘        │
     │             │
     │ 定时触发     │ 完成眨眼
     ▼             │
┌─────────┐        │
│ ENBLINK │        │
│ (闭眼)  │        │
└────┬────┘        │
     │             │
     │ 眼睑闭合完成 │
     ▼             │
┌─────────┐        │
│ DEBLINK │        │
│ (睁眼)  │────────┘
└─────────┘
```

### 3.2 眼睑遮挡判断

```cpp
// 眼睑阈值 (uT, lT) 范围: 0-255
// 0 = 完全睁开（无遮挡）
// 255 = 完全闭合（全遮挡）

if ((lower[screenIdx] <= lT) || (upper[screenIdx] <= uT)) {
    p = 0;  // 显示黑色（被眼睑遮挡）
}
```

### 3.3 眨眼动画效果

```
完全睁开 (uT=0, lT=0)          半闭 (uT=128, lT=128)
┌──────────┐                  ┌──────────┐
│    ●●    │                  │  ▔▔▔   │
│   ○  ○   │      ────────▶  │   ○  ○   │
│          │                  │          │
└──────────┘                  └──────────┘

完全闭合 (uT=255, lT=255)
┌──────────┐
│  ─────   │
│  ─────   │
│          │
└──────────┘
```

## 四、完整渲染示例

### 示例：渲染屏幕中心像素 (120, 120)

```cpp
// 1. 计算屏幕索引
screenIdx = 120 * 240 + 120 = 28920

// 2. 检查眼睑遮挡
if (lower[28920] <= 100 || upper[28920] <= 50) {
    // 被眼睑遮挡 → 显示黑色
    p = 0x0000;
}

// 3. 检查是否在虹膜区
else if (irisX >= 0 && irisX < 150 && irisY >= 0 && irisY < 150) {
    // 在虹膜区 → 使用极坐标映射
    p = polar[irisY * 150 + irisX];  // 例如: p = 0x2A5B

    // 4. 提取距离和角度
    distance = p & 0x7F;      // distance = 0x5B (91)
    angle = p >> 7;           // angle = 0x15 (21)

    // 5. 缩放距离
    d = (200 * 91) / 240;     // d = 75 (假设 iScale=200)

    // 6. 计算虹膜纹理坐标
    a = (256 * 21) / 512;     // a = 10

    // 7. 从虹膜纹理取色
    p = iris[75 * 256 + 10];  // p = 0xF800 (红色)
}

// 8. RGB565 字节序转换
currentBuf[pixelIdx] = (p >> 8) | (p << 8);
// 0xF800 → 0x00F8 (大端 → 小端)
```

## 五、性能优化技巧

### 5.1 双缓冲机制

```cpp
// 使用两个缓冲区交替渲染和显示
uint16_t* lineBuf[2];
lineBuf[0] = malloc(10 * 240 * 2);  // 缓冲区1
lineBuf[1] = malloc(10 * 240 * 2);  // 缓冲区2

// 每次处理10行
while (screenY < 240) {
    // 渲染到缓冲区0
    render_line(lineBuf[0]);

    // 显示缓冲区1（上一次渲染的）
    display_buffer(lineBuf[1]);

    // 交换缓冲区
    swap(lineBuf[0], lineBuf[1]);

    screenY += 10;
}
```

### 5.2 批量绘制

```cpp
// 一次性绘制10行，减少SPI传输次数
esp_lcd_safe_draw_bitmap(0, screenY,       // 起始坐标
                         240,              // 宽度
                         screenY + 10,     // 结束Y坐标
                         currentBuf);      // 数据
```

### 5.3 内存管理

```cpp
// 动态分配，使用后立即释放
uint16_t* lineBuf[2] = {malloc(...), malloc(...)};

// 渲染完成后释放
free(lineBuf[0]);
free(lineBuf[1]);
```

## 六、常见问题排查

### 问题1: 眼睛显示异常（花屏）

**可能原因**:
- ❌ sclera/iris 数据尺寸错误
- ❌ RGB565 格式错误
- ❌ 字节序问题

**排查方法**:
```cpp
ESP_LOGI(TAG, "SCLERA: %d×%d, IRIS: %d×%d",
         SCLERA_WIDTH, SCLERA_HEIGHT,
         IRIS_WIDTH, IRIS_HEIGHT);
```

### 问题2: 眨眼功能失效

**可能原因**:
- ❌ upper/lower 数组未初始化
- ❌ 眼睑阈值计算错误

**排查方法**:
```cpp
ESP_LOGI(TAG, "uT=%d, lT=%d, upper[0]=%d, lower[0]=%d",
         uT, lT, upper[0], lower[0]);
```

### 问题3: 虹膜缩放异常

**可能原因**:
- ❌ polar 数组数据错误
- ❌ iScale 超出范围

**排查方法**:
```cpp
ESP_LOGI(TAG, "iScale=%d (range: %d-%d)",
         iScale, IRIS_MIN, IRIS_MAX);
```

---

**总结**: 眼睛渲染系统通过巧妙的设计，使用极坐标映射实现了高效的虹膜渲染，同时通过眼睑遮罩实现了自然的眨眼效果。理解这些数据结构和渲染流程，对于开发新的眼睛主题至关重要。
