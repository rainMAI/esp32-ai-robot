# 音频系统优化指南

## 📋 概述

本文档详细说明了语音识别灵敏度的优化配置，包括麦克风增益调整和 AEC（声学回声消除）参数设置。

---

## 🔧 已完成的优化

### 1. 麦克风增益提升

**修改位置**: `main/audio/audio_codec.h`

**修改内容**:
```cpp
// 修改前
#define AUDIO_CODEC_DEFAULT_MIC_GAIN 30.0

// 修改后
#define AUDIO_CODEC_DEFAULT_MIC_GAIN 40.0  // 提高到 40 dB 以增加麦克风灵敏度
```

**效果**:
- 从 30 dB 提升到 40 dB
- 理论上提升约 **3.16 倍** 的音频信号幅度
- 显著提高语音识别的灵敏度

**注意**: 40 dB 已经是比较高的增益值，如果出现回声或啸叫，可能需要降低。

---

## 🎤 AEC（声学回声消除）配置

### 什么是 AEC？

AEC (Acoustic Echo Cancellation) 用于消除扬声器播放的声音被麦克风再次录制的回声，防止：
1. **回声**: 对方听到自己的声音延迟返回
2. **啸叫**: 扬声器声音→麦克风→扬声器形成正反馈回路

### 当前 AEC 配置状态

#### 1. 硬件层回声参考

**文件**: `main/audio/codecs/es8311_audio_codec.cc`

```cpp
// 第 11 行
input_reference_ = false; // 是否使用参考输入，实现回声消除
```

**说明**:
- `input_reference_ = false`: **未启用硬件回声参考通道**
- 这个标志用于告诉音频系统是否有硬件参考输入用于 AEC
- 大多数简单开发板**没有**回声参考硬件设计

#### 2. 软件 AEC 处理

**文件**: `main/audio/processors/afe_audio_processor.cc`

**第 35 行 - AEC 模式配置**:
```cpp
afe_config->aec_mode = AEC_MODE_VOIP_HIGH_PERF;
```

**说明**: 配置了 AEC 模式为 **VOIP 高性能模式**，但实际是否启用取决于下面的配置。

**第 55-61 行 - AEC 启用逻辑**:
```cpp
#ifdef CONFIG_USE_DEVICE_AEC
    afe_config->aec_init = true;   // 启用设备端 AEC
    afe_config->vad_init = false;  // 禁用 VAD（语音活动检测）
#else
    afe_config->aec_init = false;  // 禁用 AEC（默认配置）
    afe_config->vad_init = true;   // 启用 VAD（默认配置）
#endif
```

**当前状态**: `CONFIG_USE_DEVICE_AEC` 未启用，所以 **AEC 被禁用，VAD 被启用**。

#### 3. Kconfig 配置

**文件**: `main/Kconfig.projbuild`

**第 493-498 行**:
```kconfig
config USE_DEVICE_AEC
    bool "Enable Device-Side AEC"
    default n
    depends on USE_AUDIO_PROCESSOR && (BOARD_TYPE_ESP_BOX_3 || BOARD_TYPE_ESP_BOX || BOARD_TYPE_ESP_BOX_LITE || BOARD_TYPE_LICHUANG_DEV || BOARD_TYPE_ESP32S3_KORVO2_V3 || BOARD_TYPE_ESP32S3_Touch_AMOLED_1_75 || BOARD_TYPE_ESP32S3_Touch_AMOLED_2_06 || BOARD_TYPE_ESP32P4_WIFI6_Touch_LCD_4B || BOARD_TYPE_ESP32P4_WIFI6_Touch_LCD_XC || BOARD_TYPE_ESP_S3_LCD_EV_Board_2)
    help
        因为性能不够，不建议和微信聊天界面风格同时开启
```

**说明**:
- 设备端 AEC **仅支持特定开发板**（ESP BOX 系列、立创开发板等）
- 这些开发板具有**硬件回声参考通道设计**
- **面包板接线（面包板新版接线）不支持**设备端 AEC

---

## 💡 针对"面包板新版接线"的建议

由于您的项目使用的是 `BOARD_TYPE_BREAD_COMPACT_WIFI_CAM`（面包板接线 + LCD + Camera），该开发板**不支持设备端 AEC**，原因如下：

### 为什么不支持设备端 AEC？

1. **硬件限制**:
   - 面包板接线方案通常只连接 ES8311 的麦克风输入
   - **没有连接扬声器的参考信号**到 ES8311 的参考输入引脚
   - 没有参考信号，AEC 算法无法工作

2. **性能限制**:
   - ESP32-S3 的 CPU 性能有限
   - AEC 算法需要大量计算资源
   - 同时运行 AEC 和其他任务可能导致性能问题

---

## ✅ 推荐的优化方案

### 方案 1: 仅使用麦克风增益（推荐 - 已完成）

**配置**:
- ✅ 麦克风增益: **40 dB**（已设置）
- ❌ 设备端 AEC: **禁用**（硬件不支持）
- ✅ VAD（语音活动检测）: **启用**（默认）

**优点**:
- 配置简单
- 性能开销低
- 适合面包板接线方案

**缺点**:
- 在高音量时可能产生轻微回声
- 需要用户注意扬声器与麦克风的距离

**使用建议**:
1. 保持扬声器与麦克风 **15-30 cm** 的距离
2. 避免扬声器直接朝向麦克风
3. 如果出现啸叫，降低输出音量或麦克风增益

---

### 方案 2: 降低麦克风增益（如果出现回声/啸叫）

如果增加增益到 40 dB 后出现回声或啸叫，可以尝试降低到 35 dB：

```cpp
// main/audio/audio_codec.h
#define AUDIO_CODEC_DEFAULT_MIC_GAIN 35.0  // 降低到 35 dB
```

**平衡点**:
- 30 dB: 灵敏度较低，需要大声说话
- 35 dB: 中等灵敏度，平衡（推荐起点）
- 40 dB: 高灵敏度，可能需要调整其他参数

---

### 方案 3: 启用 AGC（自动增益控制）- 可选

**注意**: 当前配置中 AGC 是禁用的。

**文件**: `main/audio/processors/afe_audio_processor.cc`

```cpp
// 第 52 行
afe_config->agc_init = false;  // 当前禁用
```

**AGC 作用**:
- 自动调整音频增益
- 说话声音小时自动提升
- 说话声音大时自动降低
- 可以避免因增益过高导致的失真

**如何启用**:
```cpp
afe_config->agc_init = true;   // 启用 AGC
```

**建议**: 先测试 40 dB 固定增益，如果效果不理想再考虑启用 AGC。

---

## 🔍 如何测试优化效果

### 1. 编译并烧录固件

```bash
idf.py build flash monitor
```

### 2. 测试场景

| 测试场景 | 预期效果 | 需要调整 |
|---------|---------|---------|
| **近距离说话** (30-50 cm) | 能清晰识别，不需要大声说话 | ✅ 正常 |
| **中距离说话** (1-2 米) | 能识别，可能需要稍大声 | ✅ 正常 |
| **远距离说话** (3 米以上) | 可能识别不到 | ⚠️ 正常（物理限制） |
| **播放音乐时说话** | 可能识别困难 | ⚠️ 正常（无 AEC） |
| **听到回声/啸叫** | 出现回声或尖锐啸叫 | ❌ 需要降低增益 |

### 3. 调试建议

**如果 40 dB 增益导致回声/啸叫**:
1. 降低增益到 35 dB
2. 或者启用 AGC（自动增益控制）
3. 调整扬声器与麦克风的物理距离

**如果 40 dB 增益仍然不够灵敏**:
1. 检查麦克风硬件连接
2. 检查是否有物理遮挡
3. 考虑更换更高灵敏度的麦克风模块

---

## 📊 参数对比表

| 参数 | 修改前 | 修改后 | 说明 |
|-----|--------|--------|------|
| **麦克风增益** | 30.0 dB | 40.0 dB | ✅ 提升 10 dB（约 3.16 倍） |
| **硬件回声参考** | 禁用 | 禁用 | ❌ 面包板不支持 |
| **设备端 AEC** | 禁用 | 禁用 | ❌ 硬件不支持 |
| **AEC 模式** | VOIP_HIGH_PERF | VOIP_HIGH_PERF | ✅ 已配置（但未启用） |
| **VAD** | 启用 | 启用 | ✅ 默认启用 |
| **AGC** | 禁用 | 禁用 | ⚠️ 可选启用 |

---

## 🚨 常见问题

### Q1: 为什么不能启用设备端 AEC？

**A**: 面包板接线方案缺少硬件回声参考通道。要启用 AEC，需要：
1. 扬声器输出信号连接到 ES8311 的参考输入引脚
2. 使用支持 AEC 的开发板（如 ESP BOX 3）
3. 在 `idf.py menuconfig` 中启用 `CONFIG_USE_DEVICE_AEC`

### Q2: 40 dB 增益会不会太高？

**A**: 40 dB 是 ESP32 音频编解码器支持的高增益范围。如果出现：
- **回声**: 降低到 35 dB
- **啸叫**: 立即降低到 30-35 dB，或启用 AGC
- **失真**: 降低增益或启用 AGC

### Q3: 有没有其他方法提高灵敏度？

**A**:
1. **启用 AGC**（自动增益控制）
2. **调整 VAD 阈值**（降低检测阈值）
3. **硬件升级**：使用更高灵敏度的麦克风模块
4. **物理优化**：减少麦克风与用户的距离

### Q4: 为什么有时需要大声说话？

**A** 可能原因：
1. ✅ **增益太低**（已通过提升到 40 dB 解决）
2. ⚠️ **环境噪声太大**（VAD 将语音误判为噪声）
3. ⚠️ **说话距离太远**（建议 30-100 cm）
4. ⚠️ **麦克风质量问题**

---

## 📝 总结

### 已完成的优化

✅ **麦克风增益从 30 dB 提升到 40 dB**
- 位置: `main/audio/audio_codec.h:16`
- 效果: 显著提高语音识别灵敏度

### 关于 AEC 的说明

❌ **设备端 AEC 不适用于面包板接线方案**
- 原因: 缺少硬件回声参考通道
- 建议: 通过物理布局避免回声（扬声器远离麦克风）

### 后续建议

1. **先测试 40 dB 增益效果**
2. **如果出现回声/啸叫**:
   - 降低增益到 35 dB
   - 或启用 AGC 自动增益控制
3. **如果仍然不够灵敏**:
   - 检查硬件连接
   - 考虑启用 AGC
   - 优化物理布局

---

**版本**: v0.3.0
**更新时间**: 2025-01-05
**作者**: Claude Code
