# 眼睛动画系统完整指南

## 📋 目录
- [系统概述](#系统概述)
- [技术架构](#技术架构)
- [从 MP4 生成动画](#从-mp4-生成动画)
- [从 PNG 生成动画](#从-png-生成动画)
- [编译和烧录](#编译和烧录)
- [故障排查](#故障排查)
- [最佳实践](#最佳实践)

---

## 系统概述

### 功能特性
- ✅ 支持 PNG 序列帧动画
- ✅ 支持 MP4 视频转动画
- ✅ 双目同步显示（240x240 LCD）
- ✅ 可配置帧率、分辨率、循环模式
- ✅ 内存优化：分批传输（每批 10 行）
- ✅ 线程安全：互斥锁保护

### 硬件配置
```
屏幕：GC9A01 LCD × 2
分辨率：240×240
接口：SPI (SPI2_HOST + SPI3_HOST)
时钟：20 MHz
颜色：RGB565（每像素 2 字节）
```

---

## 技术架构

### 文件结构
```
eyes/
├── tools/
│   └── png_to_array_optimized.py    # PNG → C 数组转换工具
├── main/display/
│   ├── animations/
│   │   └── anim_eye.h                # 动画数据（生成的）
│   ├── simple_animation_player.c     # 动画播放器
│   ├── simple_animation_player.h
│   └── eye_display.cc                # 眼睛显示控制
└── docs/
    └── animation_system_complete_guide.md  # 本文档
```

### 核心组件

#### 1. PNG 转换工具 (`tools/png_to_array_optimized.py`)
```python
功能：
- PNG 序列 → RGB565 C 数组
- 自动字节交换（大端序）
- 优化内存布局
- 生成动画元数据结构
```

#### 2. 动画播放器 (`simple_animation_player.c`)
```c
核心功能：
- 帧率控制（8 FPS 可调）
- 循环播放
- 分批渲染（LINES_PER_BATCH=10）
- 字节交换（RGB565 → LCD 格式）
- 线程安全（互斥锁）
```

#### 3. 显示控制 (`eye_display.cc`)
```c
集成方式：
- 启动动画任务
- 暂时禁用眼睛渲染
- 可切换回正常眼睛模式
```

---

## 从 MP4 生成动画

### 步骤 1：分析视频

使用 FFmpeg 分析视频参数：
```bash
ffprobe -v error -show_entries format=duration,size:stream=width,height,r_frame_rate -of default=noprint_wrappers=1 input.mp4
```

**示例输出**：
```
width=720
height=720
r_frame_rate=24/1
duration=5.041667
```

### 步骤 2：提取 PNG 帧

#### 创建输出目录
```bash
mkdir frames
```

#### 提取帧（推荐方案）

**方案 A：标准配置（推荐）**
```bash
# 取前 2 秒，8 FPS，240x240
ffmpeg -i input.mp4 \
  -vf "fps=8,scale=240:240" \
  -t 2 \
  frames/eye_%05d.png
```
**估算**：16 帧 × 115.2 KB = **1.8 MB**

**方案 B：高质量**
```bash
# 取前 3 秒，10 FPS，240x240
ffmpeg -i input.mp4 \
  -vf "fps=10,scale=240:240" \
  -t 3 \
  frames/eye_%05d.png
```
**估算**：30 帧 × 115.2 KB = **3.5 MB**

**方案 C：小文件**
```bash
# 取前 1.5 秒，6 FPS，240x240
ffmpeg -i input.mp4 \
  -vf "fps=6,scale=240:240" \
  -t 1.5 \
  frames/eye_%05d.png
```
**估算**：9 帧 × 115.2 KB = **1.0 MB**

#### FFmpeg 参数说明
| 参数 | 说明 | 示例 |
|------|------|------|
| `-vf "fps=N"` | 每秒提取 N 帧 | `fps=8` |
| `-vf "scale=W:H"` | 缩放到 W×H | `scale=240:240` |
| `-t N` | 只提取前 N 秒 | `-t 2` |
| `-vframes N` | 只提取 N 帧 | `-vframes 16` |

### 步骤 3：验证提取结果

```bash
# 查看提取的帧数
ls frames/*.png | wc -l

# 查看文件大小
ls -lh frames/
```

**预期输出**：
```
total 1.3M
-rw-r--r-- 1 user 197121 86K eye_00001.png
-rw-r--r-- 1 user 197121 88K eye_00002.png
...
```

### 步骤 4：转换为 C 数组

```bash
python tools/png_to_array_optimized.py frames eye --width 240 --height 240 --fps 8
```

**参数说明**：
- `frames`: PNG 文件所在目录
- `eye`: 动画名称（将生成 `anim_eye.h`）
- `--width 240`: 动画宽度
- `--height 240`: 动画高度
- `--fps 8`: 帧率

**输出示例**：
```
找到 16 个 PNG 文件
分辨率: 240x240
帧率: 8 FPS
处理帧 1/16: eye_00001.png
...
✅ 成功生成动画文件: d:\code\eyes\main\display\animations\anim_eye.h
📊 文件大小: 6.48 MB
```

### 步骤 5：检查生成的文件

```bash
ls -lh main/display/animations/anim_eye.h
```

---

## 从 PNG 生成动画

### 方法 1：使用 Adobe After Effects

#### 合成设置
```
分辨率：240x240（或根据需要）
帧率：8-12 FPS
时长：1-2 秒
背景：透明或黑色
```

#### 导出设置
```
格式：PNG 序列
颜色深度：RGB 8位
alpha通道：保留（如需要透明度）
```

#### 优化技巧
1. **简化动画**：只保留关键动作
2. **减少帧数**：删除重复或过渡帧
3. **使用循环**：创建可以无缝循环的动画
4. **降低复杂度**：减少粒子、渐变等效果

### 方法 2：手动创建 PNG 序列

1. 在图像软件中创建每一帧
2. 命名格式：`eye_00000.png`, `eye_00001.png`, ...
3. 确保所有帧尺寸一致
4. 放在同一文件夹中

### 转换命令

```bash
# 全屏 240x240
python tools/png_to_array_optimized.py frames eye --width 240 --height 240 --fps 8

# 居中 120x120
python tools/png_to_array_optimized.py frames eye --width 120 --height 120 --fps 8

# 自定义尺寸
python tools/png_to_array_optimized.py frames eye --width 200 --height 200 --fps 10
```

---

## 编译和烧录

### 编译项目

```bash
idf.py build
```

**如果编译失败**：
1. 检查文件大小（建议 < 8 MB）
2. 清理构建缓存：`idf.py fullclean`
3. 重新构建

### 烧录到设备

```bash
# 只烧录
idf.py flash

# 烧录并监控串口
idf.py flash monitor

# 只监控（设备已运行）
idf.py monitor
```

### 预期日志输出

```
I (500) eye_display: 启动动画播放任务（替换正常的眼睛渲染）
I (500) simple_anim: 动画播放任务启动
I (510) simple_anim: 动画开始播放 (帧数: 16, FPS: 8, 循环: 1)
```

---

## 故障排查

### 问题 1：内存不足 (ESP_ERR_NO_MEM)

**症状**：
```
E (900) wifi:malloc buffer fail
ESP_ERROR_CHECK failed: esp_err_t 0x101 (ESP_ERR_NO_MEM)
```

**原因**：
- 动画文件过大
- 帧数过多
- 分辨率过高

**解决方案**：
1. 减少帧数（≤ 20 帧）
2. 降低分辨率（≤ 240x240）
3. 降低帧率（≤ 10 FPS）

**推荐配置**：
```
分辨率：240x240
帧数：12-16
帧率：6-8 FPS
文件大小：< 5 MB
```

### 问题 2：SPI 传输失败

**症状**：
```
E (650) lcd_panel.io.spi: spi transmit (queue) color failed
E (660) gc9a01: panel_gc9a01_draw_bitmap(302): send color failed
```

**原因**：
- 单次传输数据量过大
- SPI 缓冲区溢出

**解决方案**（已实现）：
- 使用分批传输（`LINES_PER_BATCH=10`）
- 每批只传输 10 行数据

**代码位置**：`main/display/simple_animation_player.c:195-233`

### 问题 3：花屏（显示异常）

**症状**：
- 屏幕显示乱码
- 颜色异常
- 闪烁

**可能原因**：

#### A. RGB/BGR 颜色格式错误
**检查**：
```bash
# 查看转换脚本的颜色转换
grep "rgb888_to_rgb565" tools/png_to_array_optimized.py
```

**应该使用**：RGB565（不是 BGR565）

#### B. 字节序错误
**检查**：
```c
// 确保在绘制时进行字节交换
swapped_buffer[i] = (frame_data[i] >> 8) | (frame_data[i] << 8);
```

#### C. esp_lcd_panel_draw_bitmap 参数错误
**正确用法**：
```c
// ✅ 正确：x_start, y_start, x_end, y_end
esp_lcd_panel_draw_bitmap(
    panel,
    offset_x, offset_y,
    offset_x + width, offset_y + height,  // 注意：是 x_end, y_end，不是 width, height
    data
);

// ❌ 错误：x, y, width, height（会导致花屏）
```

### 问题 4：动画卡顿

**症状**：
- 动画不流畅
- 掉帧

**解决方案**：
1. 降低帧率到 6-8 FPS
2. 减少帧数
3. 优化转换效率（确保使用分批传输）

### 问题 5：WiFi 初始化失败

**症状**：
```
E (960) wifi_init: Failed to initialize Wi-Fi
ESP_ERR_NO_MEM at wifi_station.cc:100
```

**原因**：
动画占用内存过多，影响 WiFi 驱动初始化。

**解决方案**：
减少动画文件大小（参考问题 1）。

---

## 最佳实践

### 推荐配置

#### 配置 A：全屏高清（当前使用）⭐⭐⭐⭐⭐
```
分辨率：240x240（全屏）
帧数：12-16
帧率：8 FPS
时长：1.5-2 秒
文件大小：5-7 MB
内存占用：115 KB/帧
适用：主表情动画
```

#### 配置 B：居中标准（平衡）⭐⭐⭐⭐
```
分辨率：120x120（居中）
帧数：8-12
帧率：8-10 FPS
时长：1 秒
文件大小：200-350 KB
内存占用：28.8 KB/帧
适用：通用动画
```

#### 配置 C：小巧快速（待机）⭐⭐⭐
```
分辨率：120x120（居中）
帧数：4-6
帧率：6 FPS
时长：0.8 秒
文件大小：~150 KB
内存占用：28.8 KB/帧
适用：待机、通知动画
```

### 文件大小估算

| 分辨率 | 每帧大小 | 8 帧 | 12 帧 | 16 帧 | 20 帧 |
|--------|---------|-------|-------|-------|-------|
| 240x240 | 115.2 KB | 921 KB | 1.4 MB | 1.8 MB | 2.3 MB |
| 200x200 | 80 KB | 640 KB | 960 KB | 1.3 MB | 1.6 MB |
| 120x120 | 28.8 KB | 230 KB | 345 KB | 460 KB | 576 KB |

### 性能优化建议

#### 1. 减少帧数
- 只保留关键帧
- 删除过渡帧
- 使用循环动画

#### 2. 降低帧率
- 卡通动画：6-8 FPS 足够
- 流畅动画：10-12 FPS
- 避免超过 15 FPS

#### 3. 优化分辨率
- 全屏：240x240
- 标准：120x120
- 小巧：80x80

#### 4. 压缩颜色
- 使用 RGB565（已有）
- 避免渐变（增加文件大小）
- 使用纯色或简单图案

### MP4 转 PNG 参数速查表

| 目标配置 | FFmpeg 参数 | 预计输出 |
|---------|------------|---------|
| 240x240, 16帧, 8 FPS | `-vf "fps=8,scale=240:240" -t 2` | ~1.8 MB |
| 240x240, 12帧, 10 FPS | `-vf "fps=10,scale=240:240" -t 1.2` | ~1.4 MB |
| 120x120, 8帧, 8 FPS | `-vf "fps=8,scale=120:120" -t 1` | ~230 KB |

---

## 附录

### A. 完整示例：从 MP4 到设备

#### 场景：使用 AI 生成的视频

```bash
# 1. 分析视频
ffprobe -v error -show_entries format=duration,size:stream=width,height,r_frame_rate \
  -of default=noprint_wrappers=1 input.mp4

# 输出：720x720, 24fps, 5.04s, 121 frames

# 2. 提取帧
mkdir frames
ffmpeg -i input.mp4 \
  -vf "fps=8,scale=240:240" \
  -t 2 \
  frames/eye_%05d.png

# 输出：16 frames (eye_00001.png ~ eye_00016.png)

# 3. 验证
ls frames/*.png | wc -l  # 应该是 16

# 4. 转换
python tools/png_to_array_optimized.py frames eye --width 240 --height 240 --fps 8

# 输出：anim_eye.h (6.48 MB)

# 5. 编译
idf.py build

# 6. 烧录
idf.py flash monitor
```

### B. 代码修改记录

#### 关键修复 1：分批传输
**文件**：`main/display/simple_animation_player.c`
**问题**：240x240 单次传输导致 SPI 超时
**解决**：每批传输 10 行

```c
#define LINES_PER_BATCH 10

for (uint16_t y = 0; y < ANIM_EYE_HEIGHT; y += LINES_PER_BATCH) {
    // 计算本次批处理的实际行数
    uint8_t lines_to_process = (ANIM_EYE_HEIGHT - y) < LINES_PER_BATCH ?
                               (ANIM_EYE_HEIGHT - y) : LINES_PER_BATCH;

    // 字节交换并填充当前批次的行缓冲区
    // ...（省略）

    // 绘制当前批次
    esp_lcd_panel_draw_bitmap(
        lcd_panel_eye,
        offset_x, offset_y + y,
        offset_x + ANIM_EYE_WIDTH, offset_y + y + lines_to_process,
        line_buffer
    );
}
```

#### 关键修复 2：修正 LCD 绘制参数
**问题**：参数错误导致花屏
**错误**：
```c
// ❌ 错误：width, height 被误认为 x_end, y_end
esp_lcd_panel_draw_bitmap(panel, x, y, width, height, data);
```

**正确**：
```c
// ✅ 正确：明确指定 x_end, y_end
esp_lcd_panel_draw_bitmap(panel, x, y, x + width, y + height, data);
```

#### 关键修复 3：字节交换
**位置**：`main/display/simple_animation_player.c:207-208`
```c
// 字节交换 - 和眼睛渲染逻辑一致
line_buffer[dst_offset + x] = (frame_data[src_offset + x] >> 8) |
                               (frame_data[src_offset + x] << 8);
```

### C. 系统限制

| 项目 | 限制 | 说明 |
|------|------|------|
| Flash 大小 | 16 MB | ESP32-S3 总 Flash |
| 动画文件 | < 8 MB | 建议不超过 5 MB |
| 单帧大小 | 115.2 KB | 240x240 RGB565 |
| 运行缓冲区 | 4.8 KB | 10行 × 240像素 × 2字节 |
| WiFi 内存 | ~1 MB | WiFi 驱动需求 |
| 建议留余 | > 2 MB | 给其他功能 |

### D. 相关文档

- [动画系统优化报告](animation_fix_summary.md) - v0.2.1 版本优化记录
- [眼睛显示系统分析](眼睛显示系统分析.md) - 架构详细分析
- [眼睛渲染流程详解](眼睛渲染流程详解.md) - 渲染逻辑说明
- [边缘主颈问题分析报告](边缘主颈问题分析报告.md) - 问题排查记录
- [边缘主颈问题技术分析](边缘主颈问题技术分析.md) - 技术细节

---

## 更新日志

### v1.0.0 (2025-01-05)
- ✅ 支持 MP4 视频 → PNG → C 数组转换
- ✅ 实现 240x240 全屏动画
- ✅ 优化分批传输（每批 10 行）
- ✅ 修复 SPI 传输超时问题
- ✅ 添加完整文档和使用指南

### v0.2.1 (2025-01-04)
- ✅ 优化转换脚本，文件大小减少 97.4%
- ✅ 实现 120x120 居中显示
- ✅ 添加互斥锁保护
- ✅ 修复内存不足问题

---

**最后更新**：2025-01-05
**维护者**：Claude Code
**项目版本**：v1.8.9
